<!DOCTYPE html>
<html>
<head>
  <title>Registrar Portfolio | UCT DPCH WBA</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <h1>Registrar EPA Portfolio</h1>
  <p>UCT Department of Paediatrics and Child Health</p>
</header>

<section style="padding:40px;">
  <h2 id="registrarName"></h2>
  <div id="assessmentList"></div>
</section>

<section style="text-align:center; margin:40px;">
  <a href="dashboard.html"
     style="display:inline-block;
            padding:12px 30px;
            background:#002b5c;
            color:white;
            text-decoration:none;
            border-radius:8px;
            font-weight:bold;">
    ← Back to Dashboard
  </a>
</section>

<script>
window.addEventListener("DOMContentLoaded", function() {

  const params = new URLSearchParams(window.location.search);
  const selectedName = params.get("name") || "Unknown Registrar";

  document.getElementById("registrarName").innerText =
    selectedName + " – EPA Portfolio";

  const container = document.getElementById("assessmentList");

  function formatGSDate(raw) {
    if (!raw || !raw.startsWith("Date")) return "–";
    const parts = raw.replace("Date(", "").replace(")", "").split(",");
    return `${parts[2]}/${parseInt(parts[1]) + 1}/${parts[0]}`;
  }

  function fetchEPA(spreadsheetId, gid, title, entrustmentColumnIndex) {
    return fetch(
      `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&gid=${gid}`
    )
    .then(res => res.text())
    .then(text => {
      const json = JSON.parse(text.substr(47).slice(0, -2));
      return {
        title,
        rows: json.table.rows,
        entrustmentColumnIndex
      };
    });
  }

  Promise.all([
    // EPA 1
    fetchEPA(
      "16a8w-y1XCZ-1PcGCJQtW-14WO6IClLOtU0zgykvSCgk",
      25819344,
      "EPA 1 – Structured SBAR Handover",
      32  // EPA 1 Global Entrustment column
    ),

    // EPA 2
    fetchEPA(
      "1N6yqaBddbjXwK2b_nRlC7fycHSdGVBUt88083-YDJtw",
      287751304,
      "EPA 2 – Examination of the Newborn",
      41  // Column AP in EPA 2
    )

  ]).then(results => {

    let overallHTML = "";

    results.forEach(epa => {

      let sectionHTML = "";
      let count = 0;

      epa.rows.forEach(row => {

        const traineeName = row.c[2]?.v;
        const rawDate = row.c[5]?.v;
        const hospital = row.c[8]?.v;
        const globalEntrustment = row.c[epa.entrustmentColumnIndex]?.v;

        if (
          traineeName &&
          traineeName.trim().toLowerCase() ===
          selectedName.trim().toLowerCase()
        ) {

          count++;
          const formattedDate = formatGSDate(rawDate);

          sectionHTML += `
            <div style="
              background:white;
              padding:22px;
              margin-bottom:18px;
              border-radius:10px;
              box-shadow:0 6px 18px rgba(0,0,0,0.07);
            ">

              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="font-weight:bold; color:#002b5c;">
                  Observation ${count}
                </div>

                <div style="
                  background:#002b5c;
                  color:white;
                  padding:6px 12px;
                  border-radius:20px;
                  font-size:12px;
                ">
                  Level ${globalEntrustment || "–"}
                </div>
              </div>

              <div style="margin-top:15px;">
                <strong>Date:</strong> ${formattedDate}<br>
                <strong>Hospital:</strong> ${hospital || "–"}
              </div>

            </div>
          `;
        }

      });

      if (count > 0) {
        overallHTML += `
          <h3 style="margin-top:40px; color:#002b5c;">
            ${epa.title}
          </h3>
          ${sectionHTML}
        `;
      }

    });

    if (!overallHTML) {
      overallHTML = "<p>No EPA observations recorded yet for this registrar.</p>";
    }

    container.innerHTML = overallHTML;

  });

});
</script>
</script>

</body>
</html>
