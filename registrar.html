<!DOCTYPE html>
<html>
<head>
  <title>Registrar Portfolio | UCT DPCH WBA</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <h1>Registrar EPA Portfolio</h1>
  <p>UCT Department of Paediatrics and Child Health</p>
</header>

<section style="padding:40px;">
  <h2 id="registrarName"></h2>
  <div id="assessmentList"></div>
</section>

<section style="text-align:center; margin:40px;">
  <a href="dashboard.html"
     style="display:inline-block;
            padding:12px 30px;
            background:#002b5c;
            color:white;
            text-decoration:none;
            border-radius:8px;
            font-weight:bold;">
    ← Back to Dashboard
  </a>
</section>

<script>
window.addEventListener("DOMContentLoaded", function() {

  const params = new URLSearchParams(window.location.search);
  const selectedName = params.get("name") || "Unknown Registrar";

  document.getElementById("registrarName").innerText =
    selectedName + " – EPA Observations";

  fetch("https://docs.google.com/spreadsheets/d/16a8w-y1XCZ-1PcGCJQtW-14WO6IClLOtU0zgykvSCgk/gviz/tq?tqx=out:json&gid=25819344")
    .then(res => res.text())
    .then(text => {

      const json = JSON.parse(text.substr(47).slice(0, -2));
      const rows = json.table.rows;

      let html = "";
      let count = 0;

      rows.forEach(row => {

        const traineeName = row.c[2]?.v;
        const rawDate = row.c[5]?.v;
        const hospital = row.c[8]?.v;

        if (traineeName === selectedName) {

          count++;

          let formattedDate = "–";

          if (rawDate && rawDate.startsWith("Date")) {
            const parts = rawDate
              .replace("Date(", "")
              .replace(")", "")
              .split(",");
            formattedDate =
              parts[2] + "/" + (parseInt(parts[1]) + 1) + "/" + parts[0];
          }

          html += `
            <div style="
              background:white;
              padding:25px;
              margin-bottom:25px;
              border-radius:12px;
              box-shadow:0 8px 20px rgba(0,0,0,0.08);
              max-width:700px;
            ">
              <div style="
                font-size:18px;
                font-weight:bold;
                color:#002b5c;
                margin-bottom:10px;
              ">
                EPA Observation ${count}
              </div>

              <div><strong>Date:</strong> ${formattedDate}</div>
              <div><strong>Hospital:</strong> ${hospital || "–"}</div>
            </div>
          `;
        }

      });

      if (count === 0) {
        html = "<p>No EPA observations recorded yet for this registrar.</p>";
      }

      document.getElementById("assessmentList").innerHTML = html;

    });

});
</script>

</body>
</html>
